name: Upload to PPA

on:
  push:
    tags:
      - '*'

jobs:
  upload-to-ppa:
    runs-on: ubuntu-24.04
    container:
      image: ghcr.io/${{ github.repository }}/build-deps:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    strategy:
      matrix:
        ubuntu_release: [noble, questing]

    steps:
    - name: Download source package artifact
      uses: dawidd6/action-download-artifact@v3
      with:
        workflow: build-dkms-source.yml
        name: dkms-source-package
        path: source-package
        github_token: ${{ secrets.GITHUB_TOKEN }}
        # Download artifact from the commit that this tag points to
        commit: ${{ github.sha }}

    - name: Extract source package
      run: |
        echo "Extracting source package..."
        dpkg-source -x source-package/amdxdna-dkms_*.dsc extracted-source

    - name: Update changelog for Ubuntu release
      working-directory: extracted-source
      run: |
        # Get current version from changelog
        CURRENT_VERSION=$(dpkg-parsechangelog -S Version)
        # Remove any existing release suffix (e.g., ~noble1, ~questing1)
        BASE_VERSION=$(echo "$CURRENT_VERSION" | sed 's/~[a-z]*[0-9]*$//')
        # Append new release suffix
        NEW_VERSION="${BASE_VERSION}~${{ matrix.ubuntu_release }}1"

        echo "Updating version from $CURRENT_VERSION to $NEW_VERSION"
        echo "Targeting Ubuntu ${{ matrix.ubuntu_release }}"

        # Update changelog with new version and target release
        DEBFULLNAME="AMD XDNA Driver Team" \
        DEBEMAIL="xdna-driver@amd.com" \
        dch --newversion "$NEW_VERSION" \
            --distribution "${{ matrix.ubuntu_release }}" \
            --force-distribution \
            "Rebuild for Ubuntu ${{ matrix.ubuntu_release }}"

    - name: Rebuild source package
      working-directory: extracted-source
      run: |
        echo "Building source package for ${{ matrix.ubuntu_release }}..."
        dpkg-buildpackage -S -d -us -uc

    - name: Setup GPG key
      run: |
        echo "Setting up GPG key..."
        echo "${{ secrets.PPA_GPG_PRIVATE_KEY }}" | gpg --import --batch --yes

        # Get the key ID
        GPG_KEY_ID=$(gpg --list-secret-keys --keyid-format LONG | grep sec | head -1 | awk '{print $2}' | cut -d'/' -f2)
        echo "GPG_KEY_ID=$GPG_KEY_ID" >> $GITHUB_ENV

    - name: Sign source package
      run: |
        echo "Signing package with GPG key $GPG_KEY_ID..."
        debsign -k $GPG_KEY_ID amdxdna-dkms_*~${{ matrix.ubuntu_release }}1_source.changes

    - name: Upload to PPA
      run: |
        echo "Uploading to ppa:amd-team/xrt for ${{ matrix.ubuntu_release }}..."
        dput ppa:amd-team/xrt amdxdna-dkms_*~${{ matrix.ubuntu_release }}1_source.changes
